<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <ul id="todo-list">
        <!-- To-Do items will be dynamically inserted here -->
    </ul>

    <input type="text" id="new-todo" placeholder="Add new to-do item">
    <button id="add-todo">Add</button>

    <script>
        const localStoragePrefix = 'todo_';

        let localStorageData = readLocalStorage();
        let counter = nextAvailableKey(localStorageData);

        const todoList = document.getElementById('todo-list');
        todoList.innerHTML = ''; // Clear existing list items

        loadData(localStorageData, todoList);

        const addButton = document.getElementById('add-todo');
        const newTodoInput = document.getElementById('new-todo');
        initAddButton();

        function refreshContent() {
            window.location.reload();
        }

        function loadData(data, targetElement) {
            const myData = selectMyStorageData(data);
            for (const key in myData) {
                const todoItem = createTodoItem(key, myData[key]);
                targetElement.appendChild(todoItem);
            }
        }

        function initAddButton() {
            const addButton = document.getElementById('add-todo');
            addButton.addEventListener('click', () => {
                addItemToStorage(counter, newTodoInput.value);
                counter++;

                refreshContent();
            });
        }

        function createTodoItem(key, value) {
            const listItem = document.createElement('li');

            const deleteButton = createDeleteButton(key);
            listItem.appendChild(deleteButton);

            const textLabel = document.createElement('span');
            textLabel.textContent = `${key}: ${value}`;
            listItem.appendChild(textLabel);

            return listItem;
        }

        function createDeleteButton(key) {
            const button = document.createElement('button');
            button.textContent = 'Delete';
            button.addEventListener('click', () => {
                removeItemFromStorage(key);
                refreshContent();
            });
            return button;
        }

        function selectMyStorageData(data) {
            let result = {};
            for (const key in data) {
                if (key.startsWith(localStoragePrefix)) {
                    const sanitizedKey = unsecureKey(key);
                    result[sanitizedKey] = data[key];
                }
            }
            return result;
        }

        function addItemToStorage(key, value) {
            const newTodo = value.trim();
            if (newTodo === '') return;
            const fullKey = secureKey(key);
            localStorage.setItem(fullKey, newTodo);
        }

        function removeItemFromStorage(key) {
            const fullKey = secureKey(key);
            localStorage.removeItem(fullKey);
        }

        function readLocalStorage() {
            let result = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);

                try {
                    result[key] = JSON.parse(value);
                } catch (e) {
                    result[key] = value;
                }
            }
            return result;
        }

        function secureKey(key) {
            return localStoragePrefix + key;
        }

        function unsecureKey(key) {
            if (key.startsWith(localStoragePrefix)) {
                return key.slice(localStoragePrefix.length);
            }
            return key;
        }

        function nextAvailableKey(localStorageData) {
            let sanitizedKeys = Object.keys(localStorageData)
                .filter(key => key.startsWith(localStoragePrefix))
                .map(key => unsecureKey(key));
            return getMaxKey(sanitizedKeys) + 1;
        }

        function getMaxKey(keys) {
            const numericKeys = keys.map(key => parseInt(key)).filter(num => !isNaN(num));
            if (numericKeys.length === 0)
                return 0;
            return Math.max(...numericKeys);
        }

    </script>
</body>

</html>